<!doctype html>
<html class="wv-html">
  <head>
    <style>
        /* This helps the ng-show/ng-hide animations start at the right place. */
        /* Since Angular has this but needs to load, this gives us the class early. */
        .ng-hide { display: none!important; }
    </style>
    <title ng-bind="title">Osimis Web Viewer</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- build:css styles/lib.css -->
    <!-- bower:css -->
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:css styles/app.css -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- endbuild -->
  </head>
  <body ng-app="orthanc" class="wv-body">
    <div ng-controller="OsimisWebViewer as vm" class="wv-container">
        <wv-webviewer
            wv-studylist-enabled="false"
            
            wv-study-id="vm.studyId"
            wv-serieslist-enabled="vm.mode === 'study'" 

            wv-series-id="vm.seriesId"
        ></wv-webviewer>
    </div>

    <!-- build:js js/lib.js -->
    <!-- bower:js -->
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:js js/app.js -->
    <!-- inject:js -->
    <!-- endinject -->

    <!-- inject:templates:js -->
    <!-- endinject -->
    <!-- endbuild -->

    <!-- Path served by orthanc backend -->
    <script src="../config.js" type="text/javascript"></script>
    
    <script>
    // Remove debug info and improve performances
    // Can be reactivated on the fly using "angular.reloadWithDebugInfo();" in the console
    // see https://docs.angularjs.org/guide/production#disabling-debug-data
    angular
    .module('webviewer')
    .config(['$compileProvider', function ($compileProvider) {
        $compileProvider.debugInfoEnabled(false);
    }]);
    </script>

    <script>
        angular.module('orthanc', ['webviewer'])
        .controller('OsimisWebViewer', function($scope, $location, $rootScope, WvHttpRequest, wvConfig, wvSeriesManager) {
            var vm = this;

            var orthancStudyId = $location.search().study;
            var orthancSeriesId = $location.search().series;

            vm.studyId = undefined;
            vm.seriesId = undefined;

            // Display orthanc study
            if (orthancStudyId) {
                vm.mode = 'study';
                vm.studyId = orthancStudyId;
            }
            // Display & convert orthanc series id (from url parameter) into frontend series id
            else {
                wvSeriesManager
                    .listFromOrthancSeriesId(orthancSeriesId)
                    .then(function(seriesList) {
                        // When singleframe, display the frontend series
                        if (seriesList.length === 1) {
                            vm.mode = 'series';
                            vm.seriesId = seriesList[0].id;
                        }
                        // When multiframe, consider series as a study
                        else if (!vm.studyId) {
                            // @todo @warning multiple series may be shown instead of a single one... study id should also be split...
                            var request = new WvHttpRequest();
                            request.setHeaders(wvConfig.httpRequestHeaders);
                            
                            request
                                .get(wvConfig.orthancApiURL + '/series/'+orthancSeriesId+'/study')
                                .then(function(study) {
                                    vm.mode = 'study';
                                    vm.studyId = study.data.ID;
                                });
                        }
                        else {
                            throw new Error('Invalid URL parameters');
                        }
                    }, function(err) {
                        console.error('err', err);
                    });
            }

        })
        ;
    </script>
</body>
</html>
