# Build and run js unit and integration tests.
# It requires an orthanc server plug with the web viewer plugin (at ORTHANC_URL env variable).
# This docker image may be run in conjonction with orthanc using test/docker-compose.yml

FROM markadams/chromium-xvfb

# install required dev tools (git is used by bower & npm for source retrieval)
RUN apt-get update ; apt-get install -y python3 python3-pip curl unzip \
    libgconf-2-4 git ; curl -sL https://deb.nodesource.com/setup_6.x | bash - ; \
    apt-get install -y build-essential nodejs ; npm install -g npm@latest ; \
    npm install -g bower gulp ; rm -rf /var/lib/apt/lists/*

# install source dependencies
# @note front-end dependencies could be moved in another image to avoid multiple reinstallation 
# in other dockerfile (the issue only happens when dependency cache is invalidated)
COPY tests/osimis-test-runner/requirements.txt /tests/osimis-test-runner/requirements.txt
WORKDIR /tests/osimis-test-runner
RUN pip3 install -r requirements.txt

WORKDIR /frontend
COPY frontend/package.json /frontend/package.json
RUN npm install
COPY frontend/bower.json /frontend/bower.json
RUN bower install --allow-root

# copy app content
WORKDIR /
COPY scripts/ /scripts/
COPY tests/ /tests/
COPY frontend/ /frontend/

# set command
WORKDIR /tests/osimis-test-runner
# @note avoiding the '[ ]' docker syntax equals using 'sh -c' to process ENV.
# @warning $ORTHANC_URL env doesn't seem to be overriden by docker-compose.yml
ENV ORTHANC_URL=http://orthanc:8042/
ENTRYPOINT python3 osimis-test-runner.py --manual-orthanc=$ORTHANC_URL 
